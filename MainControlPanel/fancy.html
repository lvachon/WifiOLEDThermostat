<html>
	<head>
		<title>
			WifiOLED Thermostat
		</title>
		<script>
			const baseURL = '/';
			const hist = [];
			const maxHist = 1000;
			function getInfo(){
				fetch(`${baseURL}i`).then(response=>response.json()).then(data=>{
					hist.push(data);
					while(hist.length>maxHist){hist.shift();}
					renderHist();
					renderLive();
					setTimeout(getInfo,10000);
				});
			}
			function renderHist(){
				const data = hist[hist.length-1];
				const ctx = canv.getContext('2d');
				const {width,height} = canv;
				const graphRect = {top:height*0,bottom:height*1,left:0,right:width,height:height*1.00,width};
				
				const maxTemp = hist.reduce((acc,{temp})=>{
					if(temp>acc){return temp;}
					return acc
				},data.setTemp+0.51)+0.5;
				const minTemp = hist.reduce((acc,{temp})=>{
					if(temp<acc){return temp;}
					return acc
				},data.setTemp-0.51)-0.5;

				const BGGrad = ctx.createLinearGradient(graphRect.left,graphRect.top,graphRect.left,graphRect.bottom);
				BGGrad.addColorStop(1-(data.setTemp+1-minTemp)/(maxTemp-minTemp),'hsl(0deg 100% 95%)');
				BGGrad.addColorStop(1-(data.setTemp-minTemp)/(maxTemp-minTemp),'hsl(120deg 100% 95%)');
				BGGrad.addColorStop(1-(data.setTemp-1-minTemp)/(maxTemp-minTemp),'hsl(240deg 100% 95%)');
				ctx.fillStyle=BGGrad;
				ctx.fillRect(graphRect.left,graphRect.top,graphRect.width,graphRect.height);


				const LineGrad = ctx.createLinearGradient(graphRect.left,graphRect.top,graphRect.left,graphRect.bottom);
				LineGrad.addColorStop(1-(data.setTemp+1-minTemp)/(maxTemp-minTemp),'hsl(0deg 50% 50%)');
				LineGrad.addColorStop(1-(data.setTemp-minTemp)/(maxTemp-minTemp),'hsl(120deg 50% 50%)');
				LineGrad.addColorStop(1-(data.setTemp-1-minTemp)/(maxTemp-minTemp),'hsl(240deg 50% 50%)');
				ctx.strokeStyle=LineGrad;
				ctx.fillStyle=LineGrad;
				ctx.beginPath();
				ctx.moveTo(graphRect.right-hist.length,graphRect.bottom);
				for(i=0;i<hist.length;i++){
					const x = graphRect.right-hist.length+i;
					const y = graphRect.bottom - graphRect.height*(hist[i].temp-minTemp)/(maxTemp-minTemp);
					ctx.lineTo(x,y);
					
				}
				ctx.lineTo(graphRect.right,graphRect.bottom);
				ctx.lineWidth=1;
				ctx.stroke();
				ctx.fill();

				ctx.fillStyle='#FFFFFF';
				for(i=0;i<hist.length;i++){
					const x = graphRect.right-hist.length+i;
					if(hist[i].active){
						ctx.fillRect(x-1,graphRect.bottom-5,2,5);
					}
				}
				ctx.fillStyle=LineGrad;



				ctx.font = '0.5cm sans-serif';
				let y = graphRect.bottom - graphRect.height*(data.setTemp-minTemp)/(maxTemp-minTemp);
				ctx.beginPath();
				ctx.moveTo(graphRect.left,y);
				ctx.lineTo(graphRect.right,y);
				ctx.strokeStyle='#000000';
				ctx.lineWidth=2;
				ctx.stroke();
				ctx.lineWidth=1;
				ctx.fillStyle='#000000';
				ctx.fillText(data.setTemp,graphRect.left,y-2);

				y = graphRect.bottom - graphRect.height*(data.setTemp+0.5-minTemp)/(maxTemp-minTemp);
				ctx.beginPath();
				ctx.moveTo(graphRect.left,y);
				ctx.lineTo(graphRect.right,y);
				ctx.strokeStyle='#FF0000';
				ctx.lineWidth=2;
				ctx.stroke();
				ctx.lineWidth=1;
				ctx.fillStyle='#000000';
				ctx.fillText(data.setTemp+0.5,graphRect.left,y-2);

				y = graphRect.bottom - graphRect.height*(data.setTemp-0.5-minTemp)/(maxTemp-minTemp);
				ctx.beginPath();
				ctx.moveTo(graphRect.left,y);
				ctx.lineTo(graphRect.right,y);
				ctx.strokeStyle='#0000FF';
				ctx.lineWidth=2;
				ctx.stroke();
				ctx.lineWidth=1;
				ctx.fillStyle='#000000';
				ctx.fillText(data.setTemp-0.5,graphRect.left,y-2);
				
			}
			function renderLive(){
				

				const data = hist[hist.length-1];
				Object.keys(data).forEach(key=>{
					if(document.getElementById(`stat_${key}`)){
						document.getElementById(`stat_${key}`).innerHTML=prettyData(data,key);
					}
					if(document.getElementById(`set_${key}`)){
						document.getElementById(`set_${key}`).value=data[key];
					}
				});
				


			}
			function prettyData(data,key){
				if(key==='mode'){
					return {'-1':'Off','0':'Heat','1':'Cool'}[data[`${key}`]];
				}
				if(key==='lastCycleChange'){
					return Math.floor(data[key]/6000)/10;
				}
				if(key==='active'){
					return {'0':'False','1':'True'}[data[`${key}`]];
				}
				return data[key];
			}
			function setVal(vari,val){
				fetch(`${baseURL}${vari}?x=${val}`);
			}
		</script>
		<style>
			*{font-family: sans-serif;font-size: 1cm;}
			#wrap {max-width: 1400px;margin: auto;}
			.statrow {display: flex;justify-content: space-around}
			.statblock {text-align: center;}
			.statlabel {font-weight: bold}
			.statvalue {font-variant: italic;display: inline;}
			input {width: 3em}
			#canv {width: 100%}
		</style>
	</head>
	<body>
		<div id='wrap'>
			<div class='statrow'>
				<div class='statblock'>
					<div class='statlabel'>Temp</div>
					<div id='stat_temp' class='statvalue'> </div> F
				</div>
				<div class='statblock'>
					<div class='statlabel'>Last Change</div>
					<div id='stat_lastCycleChange' class='statvalue'> </div> min
				</div>
				<div class='statblock'>
					<div class='statlabel'>Active</div>
					<div id='stat_active' class='statvalue'> </div>
				</div>
			</div>
			<canvas id='canv' width='1000' height='500'></canvas>
			<div class='statrow'>
				<div class='statblock'>
					<div class='statlabel'>Set Temp</div>
					<input id='set_setTemp'/> F
					<button onclick='setVal('t',set_setTemp.value)'>Save</button>
				</div>
				<div class='statblock'>
					<div class='statlabel'>Set Mode</div>
					<select id='set_mode'>
						<option value='0'>Heat</option>
						<option value='1'>Cool</option>
						<option value='-1'>Off</option>
					</select>
					<button onclick='setVal('m',set_mode.value)'>Save</button>
				</div>
				<div class='statblock'>
					<div class='statlabel'>Set Source</div>
					<select id='set_source'>
						<option value='0'>Local</option>
						<option value='1'>Remote</option>
					</select>
					<button onclick='setVal('s',set_source.value)'>Save</button>
				</div>
			</div>
		</div>
	</body>
	<script>
		getInfo();
	</script>
</html>